<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <style>
    :root { --bg:#5c1a1a; --panel:#131c3b; --text:#eaf0ff; --muted:#9fb0e0; --ok:#57e3a0; --warn:#ffd166; --danger:#ff6b6b; --primary:#6ee7ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:radial-gradient(900px 500px at 0% 0%,#1d2e66,transparent),var(--bg);color:var(--text);font-size:16px;}
    .wrap{max-width:600px;margin:0 auto;padding:24px 16px 36px}
    h1{margin:0 0 16px; font-size:1.5rem; text-align: center; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;}
    
    .pulse-indicator {
        display: inline-block;
        width: 10px; height: 10px;
        border-radius: 50%;
        background: var(--ok);
        margin-right: 6px;
        box-shadow: 0 0 8px var(--ok);
    }
    .pulse-indicator.dead {
        background: var(--danger);
        box-shadow: none;
        opacity: 0.5;
    }
    
    .card {
        background: rgba(255,255,255,.03);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .card-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--muted);
        margin-bottom: 12px;
        display: block;
        font-weight: 600;
    }

    .big-stat {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text);
    }
    .sub-stat {
        font-size: 0.9rem;
        color: var(--muted);
    }

    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .col { display: flex; flex-direction: column; }
    
    .gauge-container {
        height: 12px;
        background: #0d1430;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
        border: 1px solid rgba(255,255,255,.1);
    }
    .gauge-fill {
        height: 100%;
        width: 0%;
        transition: width 0.5s ease, background 0.5s ease;
        background: linear-gradient(90deg, var(--ok), #86efac);
    }
    .gauge-fill.warn {
        background: linear-gradient(90deg, var(--warn), #ffe29a);
    }
    .gauge-fill.danger {
        background: linear-gradient(90deg, var(--danger), #ff9a9a);
    }

    select {
        width: 100%;
        padding: 12px;
        background: rgba(0,0,0,.2);
        border: 1px solid rgba(255,255,255,.15);
        color: var(--text);
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 12px;
    }
    
    .cmd-box {
        background: rgba(0,0,0,.3);
        padding: 12px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--primary);
        display: none; /* Hidden by default */
    }
    
    .cmd-code {
        font-family: monospace;
        color: var(--primary);
        font-size: 0.9rem;
        overflow-x: auto;
        white-space: nowrap;
        margin-right: 10px;
    }

    button.copy-btn {
        background: rgba(110, 231, 255, 0.15);
        color: var(--primary);
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        min-width: 60px;
    }

    .status-dot {
        height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px;
        background: var(--ok);
    }

    .footer {
        text-align: center;
        font-size: 0.8rem;
        color: rgba(255,255,255,.3);
        margin-top: 32px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mission Control</h1>

    <!-- Neural Identity -->
    <div class="card">
        <span class="card-title">Neural Identity</span>
        <div class="row">
            <div class="col">
                <div class="big-stat" id="modelName">-</div>
                <div class="sub-stat" id="providerName">-</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: var(--ok); font-weight: 600;"><span class="status-dot"></span>Active</div>
            </div>
        </div>
        
        <div style="margin-top: 16px;">
            <select id="modelSelect">
                <option value="" disabled selected>Switch Model...</option>
                <optgroup label="Google (Gemini)">
                    <option value="/model google/gemini-3.1-pro-preview">Gemini 3.1 Pro (Latest)</option>
                    <option value="/model google/gemini-3-pro-preview">Gemini 3.0 Pro (Standard)</option>
                    <option value="/model google/gemini-2.5-pro">Gemini 2.5 Pro (Stable)</option>
                    <option value="/model google/gemini-2.5-flash">Gemini 2.5 Flash (Fast)</option>
                </optgroup>
                <optgroup label="OpenAI">
                    <option value="/model openai/codex-5.3">Codex 5.3 (Default)</option>
                </optgroup>
            </select>
            
            <div id="cmdBox" class="cmd-box">
                <div class="cmd-code" id="cmdText"></div>
                <button id="copyBtn" class="copy-btn">Copy</button>
            </div>
        </div>
    </div>

    <!-- Context & Session -->
    <div class="card">
        <span class="card-title">Session Context</span>
        <div class="row">
            <div class="col">
                <div class="big-stat" id="pct">0%</div>
                <div class="sub-stat">Context Used</div>
            </div>
            <div class="col" style="text-align: right;">
                <div class="big-stat" id="todayDelta">-</div>
                <div class="sub-stat">Today's Tokens</div>
            </div>
        </div>
        <div class="gauge-container">
            <div class="gauge-fill" id="fill"></div>
        </div>
        <div style="margin-top: 8px; font-size: 0.8rem; color: var(--muted); text-align: right;">
            <span id="usedOut">0</span> / <span id="maxOut">0</span> tokens
        </div>
    </div>

    <!-- System Health -->
    <div class="card">
        <span class="card-title">System Heartbeat</span>
        <div class="row" style="margin-bottom: 12px; align-items: center;">
            <div class="col">
                <span class="sub-stat">Status</span>
                <div style="font-weight: 600; font-size: 1.1rem; display: flex; align-items: center;">
                    <div id="pulse" class="pulse-indicator"></div>
                    <span id="pulseText">Online</span>
                </div>
            </div>
            <div class="col" style="text-align: right;">
                <span class="sub-stat">CPU Load</span>
                <span id="cpuLoad" style="font-weight: 700; font-size: 1.1rem; color: var(--text)">-</span>
            </div>
        </div>
        <div class="row" style="margin-bottom: 8px;">
            <div class="col" style="flex:1">
                <div style="display:flex;justify-content:space-between">
                    <span class="sub-stat">Linux Disk</span>
                    <span style="font-weight: 600; color: var(--text);" id="linuxDiskLabel">-</span>
                </div>
                <div class="gauge-container">
                    <div id="linuxDiskBar" class="gauge-fill"></div>
                </div>
            </div>
        </div>
        <div class="row" style="margin-bottom: 8px;">
            <div class="col" style="flex:1">
                <div style="display:flex;justify-content:space-between">
                    <span class="sub-stat">Share Disk</span>
                    <span style="font-weight: 600; color: var(--text);" id="shareDiskLabel">-</span>
                </div>
                <div class="gauge-container">
                    <div id="shareDiskBar" class="gauge-fill"></div>
                </div>
            </div>
        </div>
        <div class="row" style="margin-top: 12px; border-top: 1px solid rgba(255,255,255,.05); padding-top: 8px;">
            <span class="sub-stat">Last Pulse</span>
            <span style="font-size: 0.8rem; color: var(--muted);" id="lastUpdate">-</span>
        </div>
    </div>
    
    <div class="footer">
        SABER // MISSION CONTROL // V2
    </div>

  </div>

  <script>
    // DOM Elements
    const el = (id) => document.getElementById(id);
    const elements = {
        modelName: el('modelName'),
        providerName: el('providerName'),
        pct: el('pct'),
        todayDelta: el('todayDelta'),
        fill: el('fill'),
        usedOut: el('usedOut'),
        maxOut: el('maxOut'),
        linuxDiskLabel: el('linuxDiskLabel'),
        shareDiskLabel: el('shareDiskLabel'),
        linuxDiskBar: el('linuxDiskBar'),
        shareDiskBar: el('shareDiskBar'),
        lastUpdate: el('lastUpdate'),
        pulse: el('pulse'),
        pulseText: el('pulseText'),
        cpuLoad: el('cpuLoad'),
        modelSelect: el('modelSelect'),
        cmdBox: el('cmdBox'),
        cmdText: el('cmdText'),
        copyBtn: el('copyBtn')
    };

    // Helper: Simplify provider names
    const cleanProvider = (p) => {
        if (!p) return '-';
        if (p.toLowerCase().includes('google')) return 'Google';
        if (p.toLowerCase().includes('openai')) return 'OpenAI';
        return p;
    };

    // Helper: Clean model names
    const cleanModel = (m) => {
        if (!m) return '-';
        if (m.includes('gemini-3-pro')) return 'Gemini 3.0 Pro';
        if (m.includes('gemini-3.1-pro')) return 'Gemini 3.1 Pro';
        if (m.includes('gemini-2.5-pro')) return 'Gemini 2.5 Pro';
        if (m.includes('gemini-2.5-flash')) return 'Gemini 2.5 Flash';
        if (m.includes('codex')) return 'Codex 5.3';
        return m.split('/').pop();
    };

    async function update() {
        try {
            // Fetch Session Status
            const res = await fetch('./status.json?ts=' + Date.now(), { cache: 'no-store' });
            if (res.ok) {
                const data = await res.json();
                
                // Neural Identity
                elements.modelName.textContent = cleanModel(data.model);
                elements.providerName.textContent = cleanProvider(data.provider);

                // Context
                const used = Number(data.used || 0);
                const max = Number(data.max || 0);
                const pctVal = max > 0 ? (used / max) * 100 : 0;
                
                elements.pct.textContent = pctVal.toFixed(1) + '%';
                elements.fill.style.width = pctVal + '%';
                elements.usedOut.textContent = (used / 1000).toFixed(1) + 'k';
                elements.maxOut.textContent = (max / 1000).toFixed(0) + 'k';
                
                // Color logic for context
                elements.fill.className = 'gauge-fill';
                if (pctVal > 85) {
                    elements.fill.classList.add('danger');
                } else if (pctVal > 70) {
                    elements.fill.classList.add('warn');
                } else {
                    // default green
                }

                // Fetch History for Delta
                try {
                   const histRes = await fetch('./usage-history.jsonl?ts=' + Date.now());
                   if (histRes.ok) {
                       const txt = await histRes.text();
                       const lines = txt.trim().split('\n').filter(Boolean);
                       const rows = lines.map(l => JSON.parse(l));
                       
                       // Simple daily delta logic
                       const now = Math.floor(Date.now()/1000);
                       const dayStart = new Date(); dayStart.setHours(0,0,0,0);
                       const dayStartTs = Math.floor(dayStart.getTime()/1000);
                       
                       const todayRows = rows.filter(r => r.ts >= dayStartTs);
                       if (todayRows.length > 0) {
                           const startUsed = todayRows[0].used || 0;
                           const currentUsed = used;
                           const delta = Math.max(0, currentUsed - startUsed);
                           elements.todayDelta.textContent = '+' + (delta/1000).toFixed(1) + 'k';
                       }
                   }
                } catch(e) { console.log('History fetch error', e); }
                
                // Timestamp
                const date = new Date(data.updatedAt);
                const now = new Date();
                const diffSec = (now - date) / 1000;
                
                elements.lastUpdate.textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Pulse Logic
                if (diffSec < 120) {
                    elements.pulse.className = 'pulse-indicator';
                    elements.pulseText.textContent = 'Active';
                    elements.pulseText.style.color = 'var(--ok)';
                } else if (diffSec < 300) {
                    elements.pulse.className = 'pulse-indicator dead';
                    elements.pulse.style.background = 'var(--warn)';
                    elements.pulseText.textContent = 'Slow';
                    elements.pulseText.style.color = 'var(--warn)';
                } else {
                    elements.pulse.className = 'pulse-indicator dead';
                    elements.pulse.style.background = 'var(--danger)';
                    elements.pulseText.textContent = 'Offline';
                    elements.pulseText.style.color = 'var(--danger)';
                }
            }

            // Fetch System Status
            const sysRes = await fetch('./system-status.json?ts=' + Date.now(), { cache: 'no-store' });
            if (sysRes.ok) {
                const sys = await sysRes.json();
                const l = sys.linuxDisk || {};
                const sh = sys.shareDisk || {};
                elements.linuxDiskLabel.textContent = `${l.usePercent || '-'}% (${l.avail || '-'} Free)`;
                elements.shareDiskLabel.textContent = `${sh.usePercent || '-'}% (${sh.avail || '-'} Free)`;
                
                if (l.usePercent) {
                    elements.linuxDiskBar.style.width = l.usePercent + '%';
                    elements.linuxDiskBar.className = 'gauge-fill ' + (l.usePercent > 90 ? 'danger' : l.usePercent > 75 ? 'warn' : '');
                }
                if (sh.usePercent) {
                    elements.shareDiskBar.style.width = sh.usePercent + '%';
                    elements.shareDiskBar.className = 'gauge-fill ' + (sh.usePercent > 90 ? 'danger' : sh.usePercent > 75 ? 'warn' : '');
                }
                
                if (sys.cpu !== undefined) {
                    elements.cpuLoad.textContent = sys.cpu + '%';
                    if (sys.cpu > 80) elements.cpuLoad.style.color = 'var(--danger)';
                    else if (sys.cpu > 50) elements.cpuLoad.style.color = 'var(--warn)';
                    else elements.cpuLoad.style.color = 'var(--ok)';
                }
            }

        } catch (e) {
            console.error("Update failed", e);
        }
    }

    // Command Logic
    elements.modelSelect.addEventListener('change', (e) => {
        const cmd = e.target.value;
        if (cmd) {
            elements.cmdText.textContent = cmd;
            elements.cmdBox.style.display = 'flex';
            elements.copyBtn.textContent = 'Copy';
        }
    });

    elements.copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(elements.cmdText.textContent).then(() => {
            elements.copyBtn.textContent = 'Copied!';
            setTimeout(() => { elements.copyBtn.textContent = 'Copy'; }, 2000);
        });
    });

    // Init & Loop
    update();
    setInterval(update, 10000); // 10s polling (client side)
  </script>
</body>
</html>
